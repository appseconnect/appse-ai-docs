# ============================================
# GitHub:updatefromazuredevops â†’ Azure DevOps:gitsync
# Daily TEST sync pipeline
# ============================================

trigger: none   # âŒ Prevent CI loop

schedules:
  - cron: "50 9 * * *"   # â° 3:10 PM IST (UTC 09:40)
    displayName: Daily GitHub â†’ DevOps TEST Sync
    branches:
      include:
        - gitsync
    always: true

pool:
  vmImage: ubuntu-latest

# ğŸ” Variable group containing GITHUB_PAT
variables:
- group: github-sync-secrets

steps:
- checkout: self
  persistCredentials: true

- script: |
    set -e

    echo "ğŸ”§ Configuring git identity"
    git config user.name "GitHub Sync Bot"
    git config user.email "sync-bot@appseconnect.com"

    echo "ğŸ“¥ Fetching Azure DevOps branch: gitsync"
    git fetch origin gitsync

    echo "ğŸ”€ Checking out Azure DevOps branch: gitsync"
    git checkout -B gitsync origin/gitsync

    echo "ğŸ”— Adding GitHub remote"
    git remote remove github 2>/dev/null || true
    git remote add github https://$(GITHUB_PAT)@github.com/appseconnect/appse-ai-docs.git

    echo "ğŸ“¥ Fetching GitHub branch: updatefromazuredevops"
    git fetch github updatefromazuredevops

    echo "ğŸ” Checking for changes"
    if git diff --quiet HEAD github/updatefromazuredevops; then
      echo "âœ… No changes detected. Sync not required."
      exit 0
    fi

    echo "ğŸ”„ Changes detected. Performing fast-forward merge"
    git merge github/updatefromazuredevops --ff-only

    echo "ğŸš€ Pushing changes to Azure DevOps branch: gitsync"
    git push origin gitsync

    echo "âœ… TEST sync completed successfully"

  displayName: "Sync GitHub:updatefromazuredevops â†’ DevOps:gitsync"

